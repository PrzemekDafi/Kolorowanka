<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8">
  <title>FilterKid: Paralaksa 2024</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    html, body { height:100%; margin:0; padding:0; overflow:hidden; }
    body {
      width: 100vw; height: 100vh; position: relative;
      font-family: 'Press Start 2P', monospace; background: #222;
    }
    #background-img {
      position: fixed; left: 0; top: 0;
      width: 100vw; height: 100vh;
      object-fit: cover; z-index: 0; pointer-events: none; user-select: none;
    }
    #arcade-frame {
      position: fixed; left: 50%; bottom: 0;
      transform: translateX(-50%);
      width: 1100px; z-index: 2; pointer-events: none; user-select: none;
    }
    #gameContainer { position: fixed; z-index: 1; left: 50%; }
    #gameCanvas { display: block; width: 100%; height: 100%; }
    #loading {
      position: fixed; left: 50%; top:50%;
      transform: translate(-50%, -50%);
      width: 500px; min-height: 80px; font-size: 23px;
      color: #282; background: #222; text-align: center;
      display: flex; align-items: center; justify-content: center; z-index: 100;
    }
    #info, #restart {
      position: fixed; left:50%; top: 20%; transform: translate(-50%, -50%);
      width:auto; padding:15px 25px; background-color: rgba(0,136,255,0.7);
      color: #fff; font-size: 24px; border-radius: 0;
      text-align: center; z-index: 20; white-space: nowrap;
    }
    #info { pointer-events: none; }
    #restart { pointer-events: auto; }
    button {
      font-size:18px; padding:5px 15px; margin:5px;
      font-family:'Press Start 2P', monospace;
    }
  </style>
</head>
<body>
<img id="background-img" src="img/bg-gra.jpg">
<div id="gameContainer">
  <canvas id="gameCanvas" width="800" height="450" style="display:none;"></canvas>
</div>
<img id="arcade-frame" src="img/arcade.png">
<div id="loading" style="display:block;">Ładowanie gry...</div>
<div id="info" style="display:none;">Strzałki: ←/→ ruch, ↑ skok</div>
<button id="restart" style="display:none;">Zagraj ponownie</button>
<script>
function positionGameCanvas() {
  var arcade = document.getElementById('arcade-frame');
  var gameContainer = document.getElementById('gameContainer');
  var canvas = document.getElementById('gameCanvas');
  var arcadeW=1191, arcadeH=1285;
  var screenX=190, screenY=464, screenW=800, screenH=450;
  var rect = arcade.getBoundingClientRect();
  var scale = rect.width / arcadeW;
  var gameLeft = rect.left + (screenX * scale);
  var gameTop  = rect.bottom - ((arcadeH - screenY) * scale);
  var gameWidth = screenW * scale;
  var gameHeight= screenH * scale;
  gameContainer.style.left = gameLeft + "px";
  gameContainer.style.top  = gameTop + "px";
  gameContainer.style.width  = gameWidth + "px";
  gameContainer.style.height = gameHeight + "px";
  canvas.style.width  = "800px";
  canvas.style.height = "450px";
}
window.addEventListener('resize', positionGameCanvas);
const imageSources = {
  filterkid_walk1: "img/filterkid_walk1.png",
  filterkid_walk2: "img/filterkid_walk2.png",
  filterkid_rest: "img/filterkid_rest.png",
  filterkid_soft_jump: "img/filterkid_soft_jump.png",
  filterkid_dead: "img/filterkid_dead.png",
  filterkid_solid: "img/filterkid_solid.png", // dodane!
  ground_block: "img/ground_block.png",
  obstacle_block_1: "img/obstacle_block_1.png",
  obstacle_block_2: "img/obstacle_block_2.png",
  obstacle_block_3: "img/obstacle_block_3.png",
  obstacle_block_4: "img/obstacle_block_4.png",
  obstacle_block_5: "img/obstacle_block_5.png",
  obstacle_block_6: "img/obstacle_block_6.png",
  island_block: "img/island_block.png",
  island_block_crack: "img/island_block_crack.png",
  spike: "img/spike.png",
  school: "img/school.png",
  filter_token: "img/filter_token.png",
  heart_item: "img/heart_item.png",
  clock_item: "img/clock_item.png",
  plastic_enemy: "img/plastic_enemy.png",
  sky_bg: "img/sky_bg.png",
  far_bg: "img/far_bg.png",
  mid_bg: "img/mid_bg.png",
  par_tree1:"img/par_tree1.png", par_tree2:"img/par_tree2.png", par_tree3:"img/par_tree3.png",
  par_cloud1:"img/par_cloud1.png", par_cloud2:"img/par_cloud2.png", par_cloud3:"img/par_cloud3.png",
  par_car:"img/par_car.png", par_ship:"img/par_ship.png", par_bird:"img/par_bird.png", par_house:"img/par_house.png"
};
const IMAGES = {};
function preloadImages(sources, whenDone){
  let loaded=0, total=Object.keys(sources).length;
  for(let name in sources){
    IMAGES[name]=new Image();
    IMAGES[name].onload=()=>{if(++loaded===total) whenDone();};
    IMAGES[name].onerror=()=>{console.error("Błąd:",sources[name]); if(++loaded===total) whenDone();};
    IMAGES[name].src=sources[name];
  }
}
const SCREEN_W=800, SCREEN_H=450, GRID=40, PLAYER_W=28, PLAYER_H=68, GROUND_Y=SCREEN_H-GRID, LEVEL_WIDTH=7000;
function fromGround(yTiles){return GROUND_Y - GRID*yTiles;}

// === level z Excela – skrócony przykład, wstaw tu pełne dane ===
const level = {
  ground_blocks:[{x:0,y:0},{x:1,y:0}/*...*/],
  spikes:[{x:6,y:0},{x:7,y:0}/*...*/],
  obstacle_blocks:[{type:1,x:17,y:1},{type:5,x:19,y:1}/*...*/],
  islands:[{x:7,y:4,len:4}/*...*/],
  plastic_enemies:[
    {type:"ground",x:14,y:1,dir:1,min:14,max:17},
    {type:"island",island:0,pos:0,dir:1}
  ],
  filter_tokens:[{x:22,y:1}],
  heart_items:[{x:94,y:8}],
  clock_items:[{x:153,y:1}],
  school:{x:194,y:0,w:5,h:3}
};
let filterkid, camX, timer, filters_collected, lives, filterkid_solid, gameWon, gameOver, dying, dyingTy, dyingVy;
let levelEnemies, levelSpikes, levelTokens, levelBlocks, levelObstacles, levelHearts, levelClocks, levelIslands, levelSchool, islandTiles=[];
let keys={}, startingX=100, startingY=fromGround(0)-PLAYER_H;
function resetGame(){
  filterkid={x:startingX,y:startingY,vx:0,vy:0,w:PLAYER_W,h:PLAYER_H,onGround:false,facing:1,dead:false,solid:false};
  camX=0;timer=120;filters_collected=0;lives=2;filterkid_solid=false;gameWon=false;gameOver=false;dying=false;
  levelBlocks=level.ground_blocks.map(o=>({...o}));
  levelSpikes=level.spikes.map(o=>({...o}));
  levelTokens=level.filter_tokens.map(o=>({...o}));
  levelClocks=level.clock_items.map(o=>({...o}));
  levelHearts=level.heart_items.map(o=>({...o}));
  levelIslands=JSON.parse(JSON.stringify(level.islands));
  levelSchool={...level.school};
  parallaxObjects=[];
  levelObstacles=JSON.parse(JSON.stringify(level.obstacle_blocks)).map(o=>({...o,hits:1,toBreak:false}));
  islandTiles=[];
  levelIslands.forEach((isl,idx)=>{for(let k=0;k<isl.len;k++){islandTiles.push({islandIndex:idx,x:isl.x+k,y:isl.y,hits:2,cracked:false,toBreak:false});}});
  levelEnemies=[];
  level.plastic_enemies.forEach(e_template=>{
    let e;
    if(e_template.type==="ground"||e_template.type==="obstacle"){
      e={...e_template,t:e_template.type};
      e.absY= e.t==="ground" ? fromGround(e_template.y)-PLAYER_H : fromGround(e_template.y)-GRID-PLAYER_H;
    } else if(e_template.type==="island"){
      e={t:"island",island:e_template.island,pos:e_template.pos,dir:e_template.dir};
      e.absY=fromGround(level.islands[e_template.island].y)-PLAYER_H;
    }
    e.isFalling=false; e.fallVy=0;
    levelEnemies.push(e);
  });
  document.getElementById('restart').style.display='none';
}
document.getElementById('restart').onclick=resetGame;
document.addEventListener('keydown',e=>keys[e.key]=true);
document.addEventListener('keyup',e=>keys[e.key]=false);

// ...funkcje rysujące i update() jak w Twoim kodzie – ale z poprawionym drawFilterkidSprite:
// w draw():
let animStep = (Math.floor(Date.now()/20)%20 < 10) ? 0 : 1;
let solid = filterkid_solid;
drawFilterkidSprite(filterkid.x - camX,
                    dying ? dyingTy : filterkid.y,
                    filterkid.facing,
                    dying ? 'dead' : (filterkid.onGround ? (filterkid.vx ? 'walk' : 'rest') : 'jump'),
                    animStep,
                    dying,
                    solid);

// start gry
preloadImages(imageSources,function(){
  document.getElementById('loading').style.display='none';
  document.getElementById('info').style.display='';
  setTimeout(()=>{document.getElementById('info').style.display='none';},10000);
  document.getElementById('gameCanvas').style.display='';
  resetGame(); gameloop();
  positionGameCanvas();
  timerInterval=setInterval(()=>{
    if(!gameOver && !gameWon && !dying){
      timer--;
      if(timer<=0){gameOver=true;document.getElementById('restart').style.display='';}
    }
  },1000);
});
</script>
</body>
</html>
