<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Personalizacja Produktów</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<style>
/* ... [wcześniejsze style bez zmian] ... */

/* Nowe style dla cylindrycznego zawijania */
.zadruk-container {
    transition: all 0.3s ease;
}
.zadruk-container.hidden {
    display: none;
}
.wrap-slider-container {
    margin-top: 15px;
    padding: 10px;
    background: #f0f0f0;
    border-radius: 10px;
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"></script>
</head>
<body>
<div class="container">
    <div class="image-column2" id="image-column2">
        <canvas id="base-canvas" width="900" height="900" style="position: absolute; z-index: 9999;"></canvas>
        <canvas id="overlay-canvas" width="900" height="900" style="position: absolute; z-index: 1000;"></canvas>
        <div class="image-column" id="image-column"></div>
    </div>

    <div class="options-column">
        <!-- ... [wcześniejszy HTML bez zmian] ... -->
        
        <!-- Sekcja zadruku - teraz z klasą hidden domyślnie -->
        <div class="zadruk-container hidden" id="zadruk-container">
            <label for="zadruk-upload">Wgraj obrazek dla zadruku 360:</label>
            <input type="file" id="zadruk-upload" accept="image/*"><br>
            <label for="horizontal-slider-zadruk">Przesunięcie w poziomie:</label><br>
            <input type="range" id="horizontal-slider-zadruk" min="-500" max="500" value="0"><br>
            <label for="vertical-slider-zadruk">Przesunięcie w pionie:</label><br>
            <input type="range" id="vertical-slider-zadruk" min="-500" max="500" value="0"> 
            <label for="scale-slider-zadruk">Skalowanie:</label><br>
            <input type="range" id="scale-slider-zadruk" min="10" max="100" value="80">
            
            <!-- Nowy suwak do zawijania -->
            <div class="wrap-slider-container">
                <label for="wrap-slider">Zawijanie wokół butelki:</label><br>
                <input type="range" id="wrap-slider" min="0" max="100" value="0">
                <div>0% - płasko | 100% - pełne zawinięcie</div>
            </div>
        </div>
        
        <!-- ... [reszta HTML bez zmian] ... -->
    </div>
</div>

<script>
// ... [wcześniejszy kod bez zmian] ...

document.getElementById('product-select').addEventListener('change', function () {
    const product = this.value;
    // ... [wcześniejszy kod] ...
    
    // Pokazuj/ukryj sekcję zadruku w zależności od produktu
    const zadrukContainer = document.getElementById('zadruk-container');
    if (product && products[product] && products[product].includes('zadruk')) {
        zadrukContainer.classList.remove('hidden');
    } else {
        zadrukContainer.classList.add('hidden');
        // Resetuj zadruk jeśli produkt nie obsługuje
        zadrukImage = null;
        drawZadrukImage();
    }
    
    // ... [reszta kodu] ...
});

// Nowa funkcja do cylindrycznego zawijania obrazka
function applyCylindricalWrap(ctx, img, centerX, centerY, width, height, wrapFactor) {
    const segments = 20; // Liczba segmentów do podziału obrazka
    const segmentWidth = width / segments;
    const radius = width / (2 * Math.PI) * wrapFactor;
    
    for (let i = 0; i < segments; i++) {
        const srcX = i * segmentWidth;
        const angle = (i / segments) * 2 * Math.PI;
        
        // Współrzędne docelowe (przekształcone cylindrycznie)
        const destX = centerX + Math.sin(angle) * radius;
        const destY = centerY - Math.cos(angle) * radius;
        
        // Pobierz segment obrazka
        const segmentCanvas = document.createElement('canvas');
        segmentCanvas.width = segmentWidth;
        segmentCanvas.height = height;
        const segmentCtx = segmentCanvas.getContext('2d');
        segmentCtx.drawImage(
            img, 
            srcX, 0, segmentWidth, height,
            0, 0, segmentWidth, height
        );
        
        // Oblicz skalowanie dla efektu perspektywy
        const scaleY = 1 + Math.abs(Math.cos(angle)) * 0.3 * wrapFactor;
        
        // Zapisz transformację
        ctx.save();
        
        // Przesuń do środka segmentu
        ctx.translate(destX, destY);
        
        // Obrót do pozycji cylindrycznej
        ctx.rotate(angle + Math.PI/2);
        
        // Zastosuj skalowanie dla efektu głębi
        ctx.scale(1, scaleY);
        
        // Narysuj segment
        ctx.drawImage(
            segmentCanvas, 
            -segmentWidth/2, 
            -height/2, 
            segmentWidth, 
            height
        );
        
        // Przywróć transformację
        ctx.restore();
    }
}

// Zmienna do kontroli zawijania
let wrapFactor = 0;
const wrapSlider = document.getElementById('wrap-slider');
wrapSlider.addEventListener('input', (e) => {
    wrapFactor = parseInt(e.target.value) / 100;
    drawZadrukImage();
});

function drawZadrukImage() {
    const zadrukCanvas = document.createElement('canvas');
    zadrukCanvas.width = overlayCanvas.width;
    zadrukCanvas.height = overlayCanvas.height;
    const zadrukCtx = zadrukCanvas.getContext('2d');

    if (zadrukImage) {
        const selectedProduct = document.getElementById('product-select').value;
        const maskImg = new Image();
        maskImg.src = `images/${selectedProduct}/zadruk.png`;

        maskImg.onload = () => {
            zadrukCtx.clearRect(0, 0, zadrukCanvas.width, zadrukCanvas.height);
            
            const centerX = zadrukCanvas.width / 2 + horizontalOffsetZadruk;
            const centerY = zadrukCanvas.height / 2 + verticalOffsetZadruk;
            
            const scaledWidth = zadrukImage.width * scaleZadruk;
            const scaledHeight = zadrukImage.height * scaleZadruk;
            
            // Użyj cylindrycznego zawijania jeśli wrapFactor > 0
            if (wrapFactor > 0.01) {
                applyCylindricalWrap(
                    zadrukCtx,
                    zadrukImage,
                    centerX,
                    centerY,
                    scaledWidth,
                    scaledHeight,
                    wrapFactor
                );
            } else {
                // Standardowe rysowanie bez zawijania
                zadrukCtx.drawImage(
                    zadrukImage,
                    centerX - scaledWidth / 2,
                    centerY - scaledHeight / 2,
                    scaledWidth,
                    scaledHeight
                );
            }
            
            zadrukCtx.globalCompositeOperation = 'destination-in';
            zadrukCtx.drawImage(
                maskImg,
                (zadrukCanvas.width - maskImg.width) / 2,
                (zadrukCanvas.height - maskImg.height) / 2
            );
            
            overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
            overlayCtx.drawImage(zadrukCanvas, 0, 0);
        };
    }
}
</script>
</body>
</html>
