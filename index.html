<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Personalizacja Produktów</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<style>
body {
    font-family: 'Poppins', sans-serif;
    display: flex;
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    background-color: #f8f8f8;
    height: 100vh;
}
.container {
    display: flex;
    width: 100%;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
    height: 100%;
}

.options-column {
    flex: 1;
    padding: 20px;
    max-width: 900px;
    min-width: auto;
}
 
.image-column {
    flex: 1;
    padding: 0px;
    max-width: 900px;
    min-width: auto;
}
.image-column {
    display: flex;
    position: relative;
    justify-content: center;
    align-items: center;
    background-color: #fff;
    border-radius: 20px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}
.image-column2 {
    display: flex;
    position: relative;
    justify-content: center;
    align-items: center;
    background-color: #fff;
    border-radius: 20px;
    padding: 0px; 
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}
@media (max-width: 768px) {
    .image-column, .image-column2 {
        width: 100%;
        height: auto;
        justify-content: center;
    }

    .image-column img, .image-column2 img {
        width: 100%;
        height: auto;
        object-fit: contain;
        justify-content: center;
    }
}


.product-frame {
    position: relative;
    width: 100%;
    max-width: 900px;
    min-width: 400px;
    aspect-ratio: 1 / 1;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    border-radius: 20px;
    overflow: hidden;
}

.image-wrapper {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
}

.image-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    border-radius: 20px;
}

.color-input {
    margin: 5px;
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 3px;
}
.color-input label {
    font-size: 16px;
    font-weight: 600;
    color: #333;
    margin-bottom: 3px;
}

.product-select {
    margin-bottom: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}
.product-select label {
    font-size: 16px;
    font-weight: 600;
    color: #333;
    margin-bottom: 8px;
}
.grawer-column {
    justify-content: center;
    align-items: center;
    background-color: #fff;
    padding: 20px;
    margin: 10px 0 10px 0;
    border-radius: 20px;
    width: auto;
}

#file-upload {
    font-size: 16px;
    font-weight: 600;
    color: #fff;
    background-color: #28a745;
    margin-bottom: 10px;
    margin-top: 10px;
}
h1 {
    font-size: 16px;
    font-weight: 600;
    color: #fff;
    border-radius: 50px;
    text-wrap: wrap;
    background-color: #28a745;
    padding: 15px;
    width: 400px;
    margin: 20px;
}

.product-select,
.product-select input {
    padding: 10px;
    font-size: 16px;
    border-radius: 50px;
    border: 1px solid #ccc;
    width: 100%;
    max-width: 300px;
    box-sizing: border-box;
    transition: all 0.3s ease;
}
.product-select select:focus,
.product-select input:focus {
    border-color: #007bff;
    outline: none;
}

.color-input select,
.color-input input {
    padding: 10px;
    font-size: 16px;
    border-radius: 50px;
    border: 1px solid #ccc;
    width: 100%;
    max-width: 300px;
    box-sizing: border-box;
    transition: all 0.3s ease;
}
.color-input select:focus,
.color-input input:focus {
    border-color: #007bff;
    outline: none;
}
.input-container {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
}
.color-input select {
    background-color: #f9f9f9;
}
.input-container input {
    background-color: #f9f9f9;
    width: 100%;
}
.ok-button {
    padding: 8px 16px;
    font-size: 16px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}
.ok-button:hover {
    background-color: #0056b3;
}
#saveBtn {
    margin-top: 30px;
    padding: 12px 24px;
    font-size: 18px;
    font-weight: 600;
    background-color: #28a745;
    color: white;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}
#saveBtn:hover {
    background-color: #218838;
}
.error-message {
    color: red;
    font-size: 14px;
    margin-top: 10px;
}

#loadingMessage {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    padding: 20px;
    background-color: rgba(0, 0, 0, 0.8);
    color: white;
    font-size: 18px;
    border-radius: 10px;
    z-index: 1000;
}
.no-border-radius {
    border-radius: 0 !important;
}

.select-colors {
    background-color: #f0f0f0;
    border: 1px solid #ccc;
    padding: 5px;
    font-size: 16px;
    border-radius: 4px;
    color: #333;
    width: auto%;
}

#image-column {
    position: relative;
    min-width: 900px;
    max-width: 900px;
    min-height: 900px;
    max-height: 900px;
}

#base-canvas {
    position: absolute;
    top: 0;
    left: 0;
    z-index: 9999;
    pointer-events: none;
}

#overlay-canvas {
    position: absolute;
    top: 0;
    left: 0;
    z-index: 1000;
    pointer-events: none;
}

label[for="zadruk-color"] {
    visibility: hidden;
    font-size: 0px;
    padding: 0px;
    margin-bottom: 0px;
}
input#zadruk-hex {
    visibility: hidden;
    font-size: 0px;
    padding: 0px;
    margin-bottom: 0px;
}
select#zadruk-color {
    visibility: hidden;
    font-size: 0px;
    padding: 0px;
    margin-bottom: 0px;
}

/* Nowe style dla zadruku */
.zadruk-container {
    transition: all 0.3s ease;
}
.zadruk-container.hidden {
    display: none;
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"></script>
</head>
<body>
<div class="container">
    <div class="image-column2" id="image-column2">
        <canvas id="base-canvas" width="900" height="900" style="position: absolute; z-index: 9999;"></canvas>
        <canvas id="overlay-canvas" width="900" height="900" style="position: absolute; z-index: 1000;"></canvas>
        <div class="image-column" id="image-column"></div>
    </div>

    <div class="options-column">
            <h1>Nowości: WGRYWANIE NADRUKU 360. <br>Dzbanek Prisma, Bidon Sportowy,<br>butelka WoDafi</h1>
        <b><a href="https://htmlcolorcodes.com/">Wyszukiwarka kolorów HEX</a></b>
            <label for="product-select">Wybierz produkt:</label>
            <select id="product-select" class="select-colors">
                <option value="">Wybierz produkt</option>
            <option value="prisma">Dzbanek Prisma Unimax [NOWOŚĆ]</option>
            <option value="bidon_sportowy">Bidon Sportowy [NOWOŚĆ]</option>
            <option value="refeel2">WoDafi [NOWOŚĆ]</option>
          <!--  <option value="butelka_soft_03l">Butelka Soft 0,3 l</option> -->
          <option value="crystal">Dzbanek Crystal Classic</option>
             <option value="crystal_unimax">Dzbanek Crystal Unimax</option>
          <option value="astra_classic">Dzbanek Astra Classic</option>
                <option value="butelka_soft_05l">Butelka Soft 0,5 l</option>
          <!--  <option value="butelka_soft_07l">Butelka Soft 0,7 l</option>-->
                <option value="butelka_solid_05l">Butelka Solid 0,5 l</option>
                <option value="butelka_solid_07l">Butelka Solid 0,7 l</option>
                <option value="butelka_solid_steel_07l">Butelka Solid Steel 0,7 l</option>
          <option value="elastometr">Elastometr butelek Solid</option>
                <option value="bidon_twist">Bidon Twist</option>
        <option value="bidon_klasyczny">Bidon Dafi</option>
                <option value="shape_t">Shape T</option>
                <option value="shape">Shape</option>
        <option value="self">Self</option>
                <option value="easy">Easy</option>

                <option value="saturator">PushAir</option>
          <option value="saturator_butelka">PushAir Butelka 0,7</option>
          <option value="saturator_butelka_05">PushAir Butelka 0,5</option>
          <option value="filtr_butelkowy">Filtr butelkowy</option>

        </select>
        <div id="color-options"></div>
        
        <!-- Sekcja zadruku z możliwością ukrycia -->
        <div class="zadruk-container hidden" id="zadruk-container">
            <label for="zadruk-upload"><b>NOWOŚĆ!!!</b>Wgraj obrazek dla zadruku 360:</label>
            <input type="file" id="zadruk-upload" accept="image/*"><br>
            <label for="horizontal-slider-zadruk">Przesunięcie w poziomie:</label><br>
            <input type="range" id="horizontal-slider-zadruk" min="-500" max="500" value="0"><br>
            <label for="vertical-slider-zadruk">Przesunięcie w pionie:</label><br>
            <input type="range" id="vertical-slider-zadruk" min="-500" max="500" value="0"> <br>
            <label for="scale-slider-zadruk">Skalowanie:</label><br>
            <input type="range" id="scale-slider-zadruk" min="10" max="100" value="80"><br>
            <label for="rotate-slider-zadruk">Obrót:</label><br>
            <input type="range" id="rotate-slider-zadruk" min="0" max="360" value="0">
        </div>
        
        <div class="grawer-column">
            <label for="file-upload">Wgraj grawer:</label>
            <input type="file" id="file-upload" accept="image/*">
            <br>
            <label for="rotate-slider">Obrót:</label><br>
            <input type="range" id="rotate-slider" min="0" max="360" value="0">
            <br>
            <label for="vertical-slider">Przesunięcie w pionie:</label><br>
            <input type="range" id="vertical-slider" min="-200" max="200" value="0"><br>
            <label for="horizontal-slider">Przesunięcie w poziomie:</label><br>
            <input type="range" id="horizontal-slider" min="-200" max="200" value="0"><br>
            <label for="size-slider">Rozmiar obrazka:</label><br>
            <input id="size-slider" type="range" min="5" max="100" value="80">
        </div>

        <div>
            <button id="saveBtn">Zapisz jako JPG</button>
        </div>

        <div id="loadingMessage">Trwa zapis obrazu, proszę czekać...</div>
    </div>
</div>

<script>
const products = {
    prisma: ['pokrywka', 'raczka', 'zbiornik'],
    bidon_sportowy: ['zbiornik','ustnik', 'zakretka'],
    // Produkty z zadrukiem mają teraz 'cien' w konfiguracji
    refeel2: ['zadruk', 'cien', 'zakretka', 'zbiornik'],
    astra_classic: ['pokrywka','raczka', 'zbiornik'],
    crystal: ['pokrywka', 'obudowa', 'raczka', 'zbiornik'],
    crystal_unimax: ['pokrywka', 'obudowa', 'raczka', 'zbiornik'],
    butelka_soft_03l: ['ustnik', 'zakretka_z_gumka', 'filtr'],
    butelka_soft_05l: ['ustnik', 'zakretka_z_gumka', 'filtr'],
    butelka_soft_07l: ['ustnik', 'zakretka_z_gumka', 'filtr'],
    butelka_solid_05l: ['zadruk', 'cien', 'elastometr', 'elastometr_uchwyty', 'przycisk', 'zakretka_dol', 'zakretka_gora', 'filtr', 'zbiornik'],
    butelka_solid_07l: ['zadruk', 'cien', 'elastometr', 'elastometr_uchwyty', 'przycisk', 'zakretka_dol', 'zakretka_gora', 'zbiornik_solid', 'rurka'],
    butelka_solid_steel_07l: ['zadruk', 'cien', 'elastometr', 'elastometr_uchwyty', 'przycisk', 'zakretka_dol', 'zakretka_gora','zbiornik_solid_steel'],
    elastometr: ['elastometr'],
    shape_t: ['zadruk', 'cien', 'zakretka_shape', 'uszczelka_shape', 'wewnetrzna_gumka'],
    shape: ['zadruk', 'cien', 'shape_zbiornik', 'zakretka_shape', 'uszczelka_shape', 'wewnetrzna_gumka'],
    bidon_twist: ['twist-ustnik', 'twist_zakretka', 'twist_zakretka-dol', 'twist_zbiornik'],
    bidon_klasyczny: ['bidon_zatyczka', 'bidon_zakretka', 'bidon_zbiornik'],
    self: ['zadruk', 'cien', 'self_zakretka', 'self_zatyczka', 'self-zbiornik-wewnetrzny', 'self-zbiornik-zewnetrzny'],
    easy: ['elastometr', 'sama_gora_zakretki', 'zbiornik', 'gora_zakretki', 'guma_zakretki'],
    saturator: ['saturator_gora_korpus', 'saturator_butelka', 'satuator_korpus', 'przycisk_saturatora', 'saturator_gora_klapka', 'pushair_logo'],
    saturator_butelka: ['zakretka', 'dol'],
    saturator_butelka_05: ['zakretka', 'dol'],
    filtr_butelkowy: ['filtr'],
};

const colors = {
    Antracytowy_Czarny: '#161616',
    Arctic_Blue: '#95d6dc',
    Baby_Pink: '#F4C2C2',
    Barbie: '#e0218a', 
    Biały: '#ffffff',
    Bursztynowy: '#ed7e2a',
    Butter_Yellow: '#FFECB5',
    Cappuccino_Pantone_4775C: '#D7C4B7',
    Clicks: '#C4D600',
    Cobblestone: '#a99b8f',
    Cornflower_Blue: '#7391c9',
    Cytrynowy: '#F3E500',
    Dove_Blue: '#A4BCC2',
    Flamingowy: '#f04e98',
    FCB_Bordowy: '#a31d45',
    FCB_Granatowy: '#1d3874',
    FCB_Żółty: '#ffc836',
    Forest_Shade_PANTONE_NOWOŚĆ: '#93ae82',
    Gardenia: '#f0e9e0',
    Jeansowy: '#7b879e',
    Lavender: '#afa4ce',
    Lazurowy_Pantone_7542C: '#A4BCC2',
    Lilas_Pantone_NOWOŚĆ: '#b98996',
    Makowy: '#E4002B',
    Mandarynkowy: '#FF8200',
    Miętowy_Dafi: '#88DBDF',
    Miętowy_Pantone_5507C: '#9db0ac',
    Mocha_Mousse_Pantone: '#a47764',
    Niebiański: '#6CACE4',
    Peach: '#f5c09e',
    Piaskowy_Pantone_Warm_Gray: '#CBC4BC',
    Pistachio: '#d4eb8e',
    Rose_Tan: '#d29d98',
    Rose_Gold_PANTONE_NOWOŚĆ: '#b76e79',
    Różany: '#ffc0cb',
    Srebrny: '#d4d4d4',
    Stalowy_Dafi: '#768692',
    Stalowy_Pantone_430C: '#7C878E',
    Szafirowy: '#355ca8',
    Szałwiowy_Pantone_5615C: '#5e7461',
    Tendril: '#899f6a',
    Turkusowy: '#58c4c5',
    Waniliowy: '#fdd26e',
    Willow: '#9a8b4f',
    Wrzosowy: '#A7A4E0',
    Viola: '#a793b8',
    Złoty: '#D1B464',    
};

let originalImages = {};

// Globalne obiekty dla maski i cienia
let globalMaskImg = new Image();
let globalShadowImg = new Image();

document.getElementById('product-select').addEventListener('change', function () {
    const product = this.value;
    const colorOptions = document.getElementById('color-options');
    const imageColumn = document.getElementById('image-column');
    colorOptions.innerHTML = '';
    imageColumn.innerHTML = '';
    originalImages = {};

    // Resetowanie zadruku
    zadrukImage = null;

    // Pokazuj/ukryj sekcję zadruku w zależności od produktu
    const zadrukContainer = document.getElementById('zadruk-container');
    if (product && products[product] && products[product].includes('zadruk')) {
        zadrukContainer.classList.remove('hidden');
        
        // Ładowanie maski i cienia dla wybranego produktu
        globalMaskImg.src = `images/${product}/zadruk.png`;
        globalShadowImg.src = `images/${product}/cien.png`;
        
        // Opcjonalne: wymuś przerysowanie po załadowaniu cienia (jeśli zadruk już jest wybrany)
        globalShadowImg.onload = () => {
            if (zadrukImage) drawZadrukImage();
        };

    } else {
        zadrukContainer.classList.add('hidden');
        // Czyszczenie overlay jeśli brak zadruku
        drawZadrukImage();
    }

    if (product && products[product]) {
        const productFrame = document.createElement('div');
        productFrame.className = 'product-frame';
        productFrame.style.backgroundImage = `url('images/${product}.jpg')`;
        imageColumn.appendChild(productFrame);

        products[product].forEach((element, index) => {
            // Pomiń tworzenie obrazka dla 'cien' w DOM - obsługujemy go w Canvasie
            if (element === 'cien') return;

            const wrapper = document.createElement('div');
            wrapper.className = 'image-wrapper';
            wrapper.style.zIndex = index + 1;
            const img = document.createElement('img');
            img.src = `images/${product}/${element}.png`;
            img.alt = element;
            img.id = `${element}-img`;
            
            wrapper.appendChild(img);
            productFrame.appendChild(wrapper);

            originalImages[element] = img.src;

            // Pomiń inputy dla zadruku i cienia
            if (element === 'zadruk') return;

            const colorInput = document.createElement('div');
            colorInput.className = 'color-input';
            colorInput.innerHTML = `
                <label for="${element}-color">${element}:</label>
                <select id="${element}-color">
                    <option value="">Wybierz kolor</option>
                    ${Object.keys(colors).map(color => `<option value="${colors[color]}">${color}</option>`).join('')}
                </select>
                <div class="input-container">    
                    <input type="text" id="${element}-hex" placeholder="Kolor HEX">
                </div>
            `;
            colorOptions.appendChild(colorInput);

            const selectElement = document.getElementById(`${element}-color`);
            const hexInput = document.getElementById(`${element}-hex`);

            selectElement.addEventListener('change', function () {
                hexInput.value = '';
                handleColorChange(element, selectElement.value, hexInput.value);
            });

            hexInput.addEventListener('input', function () {
                handleColorChange(element, selectElement.value, hexInput.value);
            });
        });
        
        // Rysuj (czyść) Canvas zadruku
        drawZadrukImage();
    }
});

function handleColorChange(element, selectedColor, hexValue) {
    if (element === 'zadruk' || element === 'cien') {
        return;
    }

    let color = selectedColor;

    if (hexValue && isValidHex(hexValue)) {
        color = `#${hexValue.startsWith('#') ? hexValue.slice(1) : hexValue}`;
    } else if (!selectedColor && !isValidHex(hexValue)) {
        color = colors['Biały'];
    }

    colorizeImage(element, color);
}

function isValidHex(hex) {
    return /^([0-9A-F]{3}){1,2}$/i.test(hex);
}

function colorizeImage(element, color) {
    const img = document.getElementById(`${element}-img`);
    if (!img) return; // Zabezpieczenie

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const newImg = new Image();
    newImg.src = originalImages[element];
    newImg.crossOrigin = 'anonymous';

    function hexToRgb(hex) {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
            r: parseInt(result[1], 16),
            g: parseInt(result[2], 16),
            b: parseInt(result[3], 16)
        } : null;
    }

    newImg.onload = function () {
        canvas.width = newImg.width;
        canvas.height = newImg.height;
        ctx.drawImage(newImg, 0, 0);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;

        const rgb = hexToRgb(color);
        const rOverlay = rgb ? rgb.r : 255;
        const gOverlay = rgb ? rgb.g : 255;
        const bOverlay = rgb ? rgb.b : 255;

        for (let i = 0; i < data.length; i += 4) {
            const alpha = data[i + 3];
            if (alpha > 0) {
                data[i] = Math.floor((data[i] * rOverlay) / 255);
                data[i + 1] = Math.floor((data[i + 1] * gOverlay) / 255);
                data[i + 2] = Math.floor((data[i + 2] * bOverlay) / 255);
            }
        }

        ctx.putImageData(imageData, 0, 0);
        img.src = canvas.toDataURL();
    };

    if (newImg.complete) newImg.onload();
}

document.getElementById('saveBtn').addEventListener('click', function() {
    const element = document.getElementById('image-column2');
    const loadingMessage = document.getElementById('loadingMessage');
    loadingMessage.style.display = 'block';
    element.classList.add('no-border-radius');

    const selectedProduct = document.getElementById('product-select').value || 'produkt';
    const now = new Date();
    const timestamp = now.toISOString().replace(/[:.]/g, '-');

    domtoimage.toJpeg(element, { quality: 0.95 })
    .then(function(dataUrl) {
        const link = document.createElement('a');
        link.download = `${selectedProduct}_${timestamp}.jpg`;
        link.href = dataUrl;
        link.click();
        loadingMessage.style.display = 'none';
        alert('Obraz został zapisany.');
        element.classList.remove('no-border-radius');
    })
    .catch(function(error) {
        console.error('Błąd podczas generowania obrazu:', error);
        loadingMessage.style.display = 'none';
        alert('Wystąpił błąd podczas zapisywania obrazu.');
        element.classList.remove('no-border-radius');
    });
});

const baseCanvas = document.getElementById('base-canvas');
const overlayCanvas = document.getElementById('overlay-canvas');
const baseCtx = baseCanvas.getContext('2d');
const overlayCtx = overlayCanvas.getContext('2d');

// Dodatkowy canvas dla graweru
const grawerCanvas = document.createElement('canvas');
grawerCanvas.width = 900;
grawerCanvas.height = 900;
const grawerCtx = grawerCanvas.getContext('2d');

const fileUpload = document.getElementById('file-upload');
const rotateSlider = document.getElementById('rotate-slider');
const verticalSlider = document.getElementById('vertical-slider');
const horizontalSlider = document.getElementById('horizontal-slider');
const sizeSlider = document.getElementById('size-slider');

let image = new Image();
let rotation = 0;
let verticalOffset = 0;
let horizontalOffset = 0;
let scale = 1.0;

function drawOverlayImage() {
    if (!image.src) return;
    
    grawerCtx.clearRect(0, 0, grawerCanvas.width, grawerCanvas.height);
    
    const centerX = grawerCanvas.width / 2 + horizontalOffset;
    const centerY = grawerCanvas.height / 2 + verticalOffset;
    
    grawerCtx.save();
    grawerCtx.translate(centerX, centerY);
    grawerCtx.rotate((rotation * Math.PI) / 180);
    grawerCtx.translate(-centerX, -centerY);

    // Poprawione skalowanie (0.5-2.0)
    const scaleValue = 0.1 + (parseInt(sizeSlider.value, 10) / 100) * 1.5;
    
    const maxWidth = 800 * scaleValue;
    const maxHeight = 800 * scaleValue;
    const aspectRatio = image.width / image.height;

    let width, height;

    if (aspectRatio > 1) {
        width = maxWidth;
        height = maxWidth / aspectRatio;

        if (height > maxHeight) {
            height = maxHeight;
            width = maxHeight * aspectRatio;
        }
    } else {
        height = maxHeight;
        width = maxHeight * aspectRatio;

        if (width > maxWidth) {
            width = maxWidth;
            height = maxWidth / aspectRatio;
        }
    }

    grawerCtx.drawImage(image, centerX - width / 2, centerY - height / 2, width, height);
    grawerCtx.restore();
    
    // Rysuj Grawer (jako ostatni na overlayCanvas)
    // Ale uwaga: overlayCanvas jest czyszczony w drawZadrukImage, więc tutaj musimy uważać
    // Najlepiej wywołać rysowanie zadruku, które na końcu dorysuje grawer, lub na odwrót.
    // W tej wersji zróbmy prosto: Overlay ma Zadruk (z Cieniem) + Grawer.
    
    // Wywołajmy pełne odświeżenie canvasu
    drawZadrukImage(); 
}

fileUpload.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            image.src = e.target.result;
            image.onload = () => {
                drawOverlayImage();
            };
        };
        reader.readAsDataURL(file);
    }
});

rotateSlider.addEventListener('input', (event) => {
    rotation = parseInt(event.target.value, 10);
    drawOverlayImage();
});

horizontalSlider.addEventListener('input', (event) => {
    horizontalOffset = parseInt(event.target.value, 10);
    drawOverlayImage();
});

verticalSlider.addEventListener('input', (event) => {
    verticalOffset = parseInt(event.target.value, 10);
    drawOverlayImage();
});

sizeSlider.addEventListener('input', (event) => {
    drawOverlayImage();
});

// Zmienne dla zadruku
const zadrukUpload = document.getElementById('zadruk-upload');
const horizontalSliderZadruk = document.getElementById('horizontal-slider-zadruk');
const verticalSliderZadruk = document.getElementById('vertical-slider-zadruk');
const scaleSliderZadruk = document.getElementById('scale-slider-zadruk');
const rotateSliderZadruk = document.getElementById('rotate-slider-zadruk');

let zadrukImage = null;
let horizontalOffsetZadruk = 0;
let verticalOffsetZadruk = 0;
let scaleZadruk = 1;
let rotationZadruk = 0;

zadrukUpload.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            zadrukImage = new Image();
            zadrukImage.src = e.target.result;
            zadrukImage.onload = () => {
                drawZadrukImage();
            };
        };
        reader.readAsDataURL(file);
    }
});

horizontalSliderZadruk.addEventListener('input', (event) => {
    horizontalOffsetZadruk = parseInt(event.target.value, 10);
    drawZadrukImage();
});

verticalSliderZadruk.addEventListener('input', (event) => {
    verticalOffsetZadruk = parseInt(event.target.value, 10);
    drawZadrukImage();
});

scaleSliderZadruk.addEventListener('input', (event) => {
    scaleZadruk = parseInt(event.target.value, 10) / 80;
    drawZadrukImage();
});

rotateSliderZadruk.addEventListener('input', (event) => {
    rotationZadruk = parseInt(event.target.value, 10);
    drawZadrukImage();
});

function drawZadrukImage() {
    // 1. Wyczyść główny overlay
    overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);

    // 2. Jeśli jest wgrany zadruk, narysuj go
    if (zadrukImage) {
        const zadrukCanvas = document.createElement('canvas');
        zadrukCanvas.width = overlayCanvas.width;
        zadrukCanvas.height = overlayCanvas.height;
        const zadrukCtx = zadrukCanvas.getContext('2d');

        const centerX = zadrukCanvas.width / 2 + horizontalOffsetZadruk;
        const centerY = zadrukCanvas.height / 2 + verticalOffsetZadruk;
        
        const scaledWidth = zadrukImage.width * scaleZadruk;
        const scaledHeight = zadrukImage.height * scaleZadruk;
        
        // A. Rysuj zdjęcie użytkownika
        zadrukCtx.save();
        zadrukCtx.translate(centerX, centerY);
        zadrukCtx.rotate(rotationZadruk * Math.PI / 180);
        zadrukCtx.translate(-centerX, -centerY);
        
        zadrukCtx.drawImage(
            zadrukImage,
            centerX - scaledWidth / 2,
            centerY - scaledHeight / 2,
            scaledWidth,
            scaledHeight
        );
        zadrukCtx.restore();
        
        // B. Nałóż maskę (jeśli załadowana)
        if (globalMaskImg.src && globalMaskImg.complete) {
            zadrukCtx.globalCompositeOperation = 'destination-in';
            zadrukCtx.drawImage(
                globalMaskImg,
                (zadrukCanvas.width - globalMaskImg.width) / 2,
                (zadrukCanvas.height - globalMaskImg.height) / 2
            );
        }

        // C. Rysuj cień NA WIERZCHU (jeśli załadowany)
        if (globalShadowImg.src && globalShadowImg.complete && globalShadowImg.naturalWidth > 0) {
            zadrukCtx.globalCompositeOperation = 'source-over';
            zadrukCtx.drawImage(
                globalShadowImg,
                0, 0,
                zadrukCanvas.width,
                zadrukCanvas.height
            );
        }
        
        // D. Przenieś gotowy zadruk (zdjęcie+maska+cień) na główny canvas
        overlayCtx.drawImage(zadrukCanvas, 0, 0);
    }

    // 3. Na samym końcu dorysuj grawer (jeśli istnieje)
    // Dzięki temu grawer będzie ZAWSZE na wierzchu wszystkiego (zadruku i cienia)
    if (image.src) { // zmienna 'image' przechowuje grawer
         overlayCtx.drawImage(grawerCanvas, 0, 0);
    }
}
</script>
</body>
</html>
